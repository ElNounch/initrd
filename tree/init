#!/bin/sh

# Create all the symlinks to /bin/busybox
/bin/busybox mkdir -p /bin /sbin /etc /proc /sys /newroot /usr/bin /usr/sbin
/bin/busybox --install -s


# Mount things needed by this script
[ -d /dev ] || mkdir -m 0755 /dev
[ -d /var/run ] || mkdir -pm 0755 /var/run
[ -d /sys ] || mkdir /sys
[ -d /proc ] || mkdir /proc
mount -t sysfs -o nodev,noexec,nosuid none /sys
mount -t proc -o nodev,noexec,nosuid none /proc
mount -t devtmpfs -o mode=0755 none /dev
mkdir /dev/pts
mount -t devpts -o noexec,nosuid,gid=5,mode=0620 none /dev/pts


# Loading functions
. /functions


# Initial /proc/cmdline parsing
export METADATA_IP=$(get_opt METADATA_IP 169.254.42.42)


# Verbose mode
log_begin_msg "Checking metadata for debug mode"
if [ "$(get_metadata INITRD_DEBUG)" = "1" ]; then
    log_success_msg "Enabling initrd debug"
    log_end_msg
    set -x
else
    log_end_msg
fi


# Drop debug shell
log_begin_msg "Checking metadata for debug shell"
if [ "$(get_metadata INITRD_PRE_SHELL)" = "1" ]; then
    log_success_msg "Dropping a debug shell"
    log_end_msg
    echo "**DEBUG SHELL** (requested from the TAGS metadata of the server)"
    echo "To continue the initrd process, just type C^d"
    /bin/sh
else
    log_end_msg
fi


# Signal to the console that the kernel is started
signal_state kernel-started


# Adjust time
log_begin_msg "Adjusting time (ntp)"
ntpdate -d -b -p 2 ntp.int.cloud.online.net >/dev/null
ntpdate -d -b -p 6 ntp.int.cloud.online.net >/dev/null 2>/dev/null &
log_end_msg


# Defaults
init="/sbin/init"
root="/dev/nbd0"
boot="local"
rootmnt="/newroot"

# Process command line options
for i in $(cat /proc/cmdline); do
    case "${i}" in
        root\=*)
            root=$(get_opt "${i}")
            ;;
        init\=*)
            init=$(get_opt "${i}")
            ;;
        boot\=*)
            boot=$(get_opt "${i}")
            ;;
    esac
done


# Import boot-type functions
case "${boot}" in
    local)
        . ./boot-nbd
        ;;
    rescue)
        . ./boot-rescue
        ;;
esac


# Mountroot
mountroot


# Signal to the console that the server is booted
signal_state booted


# Drop debug shell
log_begin_msg "Checking metadata for debug shell"
if [ "$(get_metadata INITRD_POST_SHELL)" = "1" ]; then
    log_success_msg "Dropping a debug shell"
    log_end_msg
    echo "**DEBUG SHELL** (requested from the TAGS metadata of the server)"
    echo "To continue the initrd process, just type C^d"
    /bin/sh
else
    log_end_msg
fi


# Check if $init exists and is executable
if [[ -x "${rootmnt}/${init}" ]] ; then
    # Unmount all other mounts so that the ram used by
    # the initramfs can be cleared after switch_root
    umount /sys /proc

    # Switch to the new root and execute init
    exec switch_root "${rootmnt}" "${init}"
fi


# This will only be run if the exec above failed
echo "Failed to switch_root, dropping to a shell"
exec /bin/sh
